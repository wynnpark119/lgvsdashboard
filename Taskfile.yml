# =============================================================================
# LG VS GEO - LinkedIn Intelligence Taskfile
# =============================================================================
# ì„¤ì¹˜: https://taskfile.dev/installation/
# ì‚¬ìš©ë²•: task <command>
# =============================================================================

version: '3'

vars:
  VENV: .venv
  PYTHON: "{{.VENV}}/bin/python"
  GEO: "{{.VENV}}/bin/geo"
  LOG_DIR: ./logs
  BACKUP_DIR: ./backups
  DATA_DIR: ./data
  DATE:
    sh: date +%Y%m%d_%H%M%S

tasks:
  # ===========================================================================
  # ì„¤ì¹˜
  # ===========================================================================
  install:
    desc: ì˜ì¡´ì„± ì„¤ì¹˜
    cmds:
      - python3.11 -m venv {{.VENV}}
      - "{{.VENV}}/bin/pip install --upgrade pip"
      - "{{.VENV}}/bin/pip install -e '.[dev]'"
    status:
      - test -f {{.VENV}}/bin/geo

  # ===========================================================================
  # ë°ì´í„°ë² ì´ìŠ¤
  # ===========================================================================
  init-db:
    desc: DB ì´ˆê¸°í™” + ì‹œë“œ ë°ì´í„°
    deps: [ensure-dirs]
    cmds:
      - "{{.GEO}} init-db --seed 2>&1 | tee -a {{.LOG_DIR}}/init-db.log"

  # ===========================================================================
  # ìˆ˜ì§‘ - ì „ì²´
  # ===========================================================================
  collect-all:
    desc: ì „ì²´ ìˆ˜ì§‘ (CSE + RSS + Email)
    deps: [ensure-dirs]
    cmds:
      - task: collect-cse
      - task: collect-rss
      - task: collect-email
      - echo "âœ… ì „ì²´ ìˆ˜ì§‘ ì™„ë£Œ {{.DATE}}"

  # ===========================================================================
  # ìˆ˜ì§‘ - Google CSE
  # ===========================================================================
  collect-cse:
    desc: Google CSE ìˆ˜ì§‘ (5ê°œ ì¿¼ë¦¬, ê° 3í˜ì´ì§€)
    deps: [ensure-dirs]
    cmds:
      - echo "ğŸ” Google CSE ìˆ˜ì§‘ ì‹œì‘ {{.DATE}}"
      - |
        for qid in 1 2 3 4 5; do
          echo "  ì¿¼ë¦¬ ID $qid ìˆ˜ì§‘ ì¤‘..."
          {{.GEO}} ingest google-cse --query-id $qid --pages 3 2>&1 | tee -a {{.LOG_DIR}}/cse_{{.DATE}}.log || true
          sleep 2
        done
      - echo "âœ… CSE ìˆ˜ì§‘ ì™„ë£Œ"

  # ===========================================================================
  # ìˆ˜ì§‘ - RSS
  # ===========================================================================
  collect-rss:
    desc: RSS í”¼ë“œ ìˆ˜ì§‘
    deps: [ensure-dirs]
    cmds:
      - echo "ğŸ“¡ RSS ìˆ˜ì§‘ ì‹œì‘ {{.DATE}}"
      - |
        for sid in 1 2 3; do
          {{.GEO}} ingest rss --source-id $sid 2>&1 | tee -a {{.LOG_DIR}}/rss_{{.DATE}}.log || true
        done
      - echo "âœ… RSS ìˆ˜ì§‘ ì™„ë£Œ"

  # ===========================================================================
  # ìˆ˜ì§‘ - Email
  # ===========================================================================
  collect-email:
    desc: Email (.eml) ìˆ˜ì§‘
    deps: [ensure-dirs]
    cmds:
      - echo "ğŸ“§ Email ìˆ˜ì§‘ ì‹œì‘ {{.DATE}}"
      - |
        if [ -d "{{.DATA_DIR}}/eml" ] && [ "$(ls -A {{.DATA_DIR}}/eml 2>/dev/null)" ]; then
          {{.GEO}} ingest email --path {{.DATA_DIR}}/eml --query-id 1 2>&1 | tee -a {{.LOG_DIR}}/email_{{.DATE}}.log || true
        else
          echo "  âš ï¸ {{.DATA_DIR}}/eml í´ë”ê°€ ë¹„ì–´ìˆìŒ"
        fi
      - echo "âœ… Email ìˆ˜ì§‘ ì™„ë£Œ"

  # ===========================================================================
  # ë°±ì—…
  # ===========================================================================
  backup:
    desc: DB ë°±ì—… (ë‚ ì§œë³„)
    deps: [ensure-dirs]
    cmds:
      - echo "ğŸ’¾ DB ë°±ì—… ì‹œì‘ {{.DATE}}"
      - |
        if [ -f "{{.DATA_DIR}}/geo.db" ]; then
          cp {{.DATA_DIR}}/geo.db {{.BACKUP_DIR}}/geo_{{.DATE}}.db
          echo "âœ… ë°±ì—… ì™„ë£Œ: {{.BACKUP_DIR}}/geo_{{.DATE}}.db"
          find {{.BACKUP_DIR}} -name "*.db" -mtime +30 -delete 2>/dev/null || true
          echo "  ğŸ—‘ï¸ 30ì¼ ì´ìƒ ëœ ë°±ì—… ì •ë¦¬ ì™„ë£Œ"
        else
          echo "  âš ï¸ DB íŒŒì¼ ì—†ìŒ"
          exit 1
        fi

  # ===========================================================================
  # ëŒ€ì‹œë³´ë“œ
  # ===========================================================================
  dashboard:
    desc: Streamlit ëŒ€ì‹œë³´ë“œ ì‹¤í–‰
    cmds:
      - "{{.GEO}} dashboard"

  # ===========================================================================
  # ì •ë¦¬
  # ===========================================================================
  clean:
    desc: ìºì‹œ ì •ë¦¬
    cmds:
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
      - echo "âœ… ì •ë¦¬ ì™„ë£Œ"

  clean-logs:
    desc: 7ì¼ ì´ìƒ ëœ ë¡œê·¸ ì‚­ì œ
    cmds:
      - find {{.LOG_DIR}} -name "*.log" -mtime +7 -delete 2>/dev/null || true
      - echo "âœ… ë¡œê·¸ ì •ë¦¬ ì™„ë£Œ"

  # ===========================================================================
  # ìœ í‹¸ë¦¬í‹°
  # ===========================================================================
  ensure-dirs:
    internal: true
    cmds:
      - mkdir -p {{.LOG_DIR}} {{.BACKUP_DIR}} {{.DATA_DIR}}/eml {{.DATA_DIR}}/csv
    status:
      - test -d {{.LOG_DIR}}
      - test -d {{.BACKUP_DIR}}

  # ===========================================================================
  # ì¼ì¼ ì‘ì—… (Cron ëŒ€ì²´)
  # ===========================================================================
  daily:
    desc: ì¼ì¼ ì‘ì—… (ìˆ˜ì§‘ + ë°±ì—…)
    cmds:
      - task: backup
      - task: collect-all
      - task: clean-logs
      - echo "âœ… ì¼ì¼ ì‘ì—… ì™„ë£Œ {{.DATE}}"
